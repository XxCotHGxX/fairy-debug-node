<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairy Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#111827', 800: '#1f2937', 700: '#374151', 600: '#4b5563', 400: '#9ca3af', 300: '#d1d5db' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        input,
        textarea {
            background-color: #1e293b;
            border-color: #334155;
            color: #f1f5f9;
        }

        input:focus,
        textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #3b82f6;
            outline: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>

<body class="p-4 h-screen overflow-hidden bg-[#0f172a]">
    <div
        class="w-full h-full max-w-[1900px] mx-auto bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 flex flex-col">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">ðŸ§š
                Fairy Debugger</h1>
            <div class="flex items-center gap-4">
                <div id="statusBadge" class="px-3 py-1 rounded-full text-xs font-mono bg-gray-700 text-gray-400">Ready
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
            <!-- Left Col: Input -->
            <div class="space-y-4 flex flex-col h-full">
                <!-- Paste Row Feature -->
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Paste Row
                        (Tab-Separated)</label>
                    <textarea id="paste_row" rows="2"
                        class="w-full rounded-lg p-3 bg-gray-800 border border-gray-600 focus:border-purple-500 transition-colors text-xs"
                        placeholder="Paste full row from Google Sheets here..."></textarea>
                    <button onclick="parseRow()"
                        class="mt-2 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-xs transition-colors">
                        ðŸ“‹ Parse & Populate
                    </button>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Competition
                        ID</label>
                    <input type="text" id="competition_id"
                        class="w-full rounded-lg p-3 bg-gray-900 border border-gray-700 focus:border-purple-500 transition-colors"
                        placeholder="smartphone-decimeter-2022">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Datarow
                            ID</label>
                        <input type="text" id="datarow_id"
                            class="w-full rounded-lg p-3 bg-gray-900 border border-gray-700 focus:border-purple-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Debug
                            Step</label>
                        <input type="number" id="debug_step" value="0"
                            class="w-full rounded-lg p-3 bg-gray-900 border border-gray-700 focus:border-purple-500 transition-colors">
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-0">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Code</label>
                    <textarea id="code"
                        class="w-full flex-1 rounded-lg p-3 bg-gray-900 border border-gray-700 focus:border-purple-500 transition-colors font-mono text-xs leading-relaxed resize-none"
                        spellcheck="false"></textarea>
                </div>

                <div class="flex gap-4">
                    <button onclick="runSubmission()" id="runBtn"
                        class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-indigo-700 transform hover:scale-[1.02] transition-all shadow-lg">
                        ðŸš€ Run on GPU
                    </button>
                    <button onclick="cancelSubmission()" id="cancelBtn" disabled
                        class="bg-red-900 text-red-200 font-bold py-3 px-6 rounded-lg hover:bg-red-800 transition-all opacity-50 disabled:cursor-not-allowed">
                        ðŸ›‘ Stop
                    </button>
                    <button onclick="markNoRepro()" id="noReproBtn"
                        class="bg-green-800 text-green-200 font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all shadow-lg text-xs">
                        âœ… No Repro (>6m)
                    </button>
                </div>

                <!-- Generate Row Button -->
                <div class="mt-8 pt-8 border-t border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4">Spreadsheet Tools</h3>
                    <button onclick="generateRow()" id="genRowBtn"
                        class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:from-green-700 hover:to-teal-700 transform hover:scale-[1.02] transition-all shadow-lg">
                        ðŸ“Š Generate Sheet Row
                    </button>
                </div>
            </div>

            <!-- Right Col: Output -->
            <div class="space-y-4 flex flex-col h-full min-h-0">
                <!-- Loader / Live Terminal -->
                <div id="loader"
                    class="hidden flex-1 flex flex-col p-4 rounded-lg bg-gray-900 border border-purple-500/30 text-center min-h-0">
                    <div
                        class="text-purple-400 font-mono animate-pulse mb-4 flex justify-between items-center shrink-0">
                        <span>Processing...</span>
                        <span id="timer">0s</span>
                    </div>

                    <div class="text-left flex-1 flex flex-col min-h-0">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 shrink-0">Live Terminal
                            Output</label>
                        <pre id="live_terminal"
                            class="bg-black text-gray-300 p-3 rounded border border-gray-800 text-[10px] font-mono flex-1 overflow-y-auto scrollbar-thin whitespace-pre-wrap"></pre>
                    </div>
                </div>

                <!-- Row Generation Results -->
                <div id="row_results" class="hidden space-y-4 flex-1 flex flex-col min-h-0 overflow-hidden">
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Raw
                            Tab-Separated String (Copy this)</label>
                        <textarea id="raw_string_output" rows="4" readonly
                            class="w-full rounded-lg p-3 bg-black border border-gray-600 font-mono text-xs text-green-400"></textarea>
                        <button onclick="copyText('raw_string_output')"
                            class="mt-2 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-xs transition-colors">
                            ðŸ“‹ Copy to Clipboard
                        </button>
                    </div>

                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 flex-1 flex flex-col min-h-0">
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 shrink-0">Column
                            Inspection</label>
                        <div id="columns_container" class="space-y-4 overflow-y-auto flex-1 pr-2">
                            <!-- Columns will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let startTime;
        let timerInterval;
        let pollInterval;

        async function runSubmission() {
            const data = getFormData();

            // Confirm before running
            const competition = document.getElementById('competition_id').value;
            const datarow = document.getElementById('datarow_id').value;
            const step = document.getElementById('debug_step').value;
            const filename = `${competition}_${datarow}_${step}.py`;

            if (!confirm(`Are you sure you want to run step ${step}?\n\nThis will:\n1. Create/overwrite: ${filename}\n2. Submit to GPU cluster\n3. Start execution\n\nMake sure you've reviewed the code first!`)) {
                return;
            }

            // Reset UI
            document.getElementById('row_results').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('runBtn').disabled = true;
            document.getElementById('runBtn').classList.add('opacity-50');
            document.getElementById('cancelBtn').disabled = false;
            document.getElementById('cancelBtn').classList.remove('opacity-50');

            document.getElementById('live_terminal').innerText = "Initializing...";

            updateStatus("Initializing...", "bg-yellow-600");
            startTimer();

            try {
                const res = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`Server error (${res.status}): ${errText}`);
                }

                const json = await res.json();
                if (json.status === 'error') {
                    throw new Error(json.message);
                }

                updateStatus("GPU Running...", "bg-blue-600");
                pollStatus(data.datarow_id, data.debug_step, data);
            } catch (e) {
                alert("Error starting submission: " + e.message);
                resetUI();
            }
        }

        async function generateRow() {
            const data = getFormData();

            // Reset UI
            document.getElementById('row_results').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('live_terminal').innerText = "Generating spreadsheet row...";
            updateStatus("Generating Row...", "bg-teal-600");
            startTimer();

            try {
                const res = await fetch('/api/generate_row', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();

                stopTimer();
                document.getElementById('loader').classList.add('hidden');

                if (json.status === 'success') {
                    renderRowResults(json);
                    updateStatus("Row Generated", "bg-green-600");
                } else {
                    alert("Error: " + json.message);
                    resetUI();
                }
            } catch (e) {
                alert("Error generating row: " + e);
                resetUI();
            }
        }

        function renderRowResults(data) {
            document.getElementById('row_results').classList.remove('hidden');
            document.getElementById('raw_string_output').value = data.raw_string;

            const container = document.getElementById('columns_container');
            container.innerHTML = '';

            // Define column order and labels (F through S)
            const columns = [
                { key: 'code', label: 'F: code' },
                { key: '_term_out', label: 'G: _term_out' },
                { key: 'exec_time', label: 'H: exec_time' },
                { key: 'output_logs', label: 'I: output_logs' },
                { key: 'bug_confirmed', label: 'J: bug_confirmed' },
                { key: 'proposed_debug_analysis_accurate', label: 'K: proposed_debug_analysis_accurate' },
                { key: 'initial_bug_reproducible', label: 'L: initial_bug_reproducible' },
                { key: 'bug_fixed', label: 'M: bug_fixed' },
                { key: 'all_bugs_fixed', label: 'N: all_bugs_fixed' },
                { key: 'revised_analysis', label: 'O: revised_analysis' },
                { key: 'revised_plan', label: 'P: revised_plan' },
                { key: 'debug_step', label: 'Q: debug_step' },
                { key: 'current_debug_code', label: 'R: current_debug_code' },
                { key: 'output_logs_after_fix', label: 'S: output_logs_after_fix' }
            ];

            columns.forEach(col => {
                const val = data.columns[col.key] || "";
                const div = document.createElement('div');
                div.className = "relative group";

                let extraBtn = "";
                // Add Apply button for the new code column
                if (col.key === 'current_debug_code') {
                    extraBtn = `<button onclick="applyCodeAndNext()" class="absolute top-0 right-0 mt-8 mr-16 opacity-0 group-hover:opacity-100 bg-purple-600 text-xs px-2 py-1 rounded text-white font-bold transition-opacity hover:bg-purple-500 shadow-lg">âš¡ Apply & Next</button>`;
                }

                // Use a unique ID for each cell to allow copying
                const cellId = `col_${col.key}`;

                div.innerHTML = `
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">${col.label}</label>
                    <div id="${cellId}" class="bg-black p-3 rounded border border-gray-800 text-xs font-mono text-gray-300 h-24 overflow-y-auto scrollbar-thin whitespace-pre-wrap break-all">${escapeHtml(val)}</div>
                    <button onclick="copyText('${cellId}')" class="absolute top-0 right-0 mt-8 mr-2 opacity-0 group-hover:opacity-100 bg-gray-700 text-xs px-2 py-1 rounded text-white transition-opacity hover:bg-gray-600">Copy</button>
                    ${extraBtn}
                `;
                container.appendChild(div);
            });
        }

        function applyCodeAndNext() {
            const codeDiv = document.getElementById('col_current_debug_code');
            if (!codeDiv) return;

            const newCode = codeDiv.innerText; // innerText decodes HTML entities
            if (!newCode) {
                alert("No code to apply.");
                return;
            }

            document.getElementById('code').value = newCode;

            const stepInput = document.getElementById('debug_step');
            let currentStep = parseInt(stepInput.value) || 0;
            stepInput.value = currentStep + 1;

            alert(`Code applied and step incremented to ${currentStep + 1}.`);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function cancelSubmission() {
            const datarow_id = document.getElementById('datarow_id').value;
            const debug_step = document.getElementById('debug_step').value;

            if (confirm("Are you sure you want to stop the GPU job?\n\nThis will:\n1. Cancel the local process\n2. Cancel the remote GPU job\n3. Verify cancellation succeeded")) {
                try {
                    const res = await fetch(`/api/cancel/${datarow_id}/${debug_step}`, { method: 'POST' });
                    const json = await res.json();

                    // Show detailed confirmation
                    if (json.status === "success") {
                        alert("âœ“ SUCCESS: " + json.message);
                        resetUI();
                        updateStatus("Cancelled", "bg-green-600");
                    } else if (json.status === "warning") {
                        alert("âš  WARNING: " + json.message + "\n\nPlease verify the job was cancelled on the GPU server.");
                        updateStatus("Cancellation Warning", "bg-yellow-600");
                    } else {
                        alert("âœ— ERROR: " + (json.message || "Failed to cancel job"));
                        updateStatus("Cancel Failed", "bg-red-600");
                    }
                } catch (e) {
                    alert("Failed to cancel: " + e);
                }
            }
        }

        async function markNoRepro() {
            const data = getFormData();

            if (!confirm("Mark as No Repro (>6m)?\n\nThis will:\n1. Cancel any running job (with remote confirmation).\n2. Verify job cancellation succeeded.\n3. Skip future runs for this file.\n4. Generate 'Pass' values.")) return;

            // Reset UI mainly to clear old results, but skip the full 'loader' flow since it's instant
            document.getElementById('row_results').classList.add('hidden');
            updateStatus("Marking No Repro...", "bg-green-600");

            try {
                const res = await fetch('/api/mark_no_repro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();

                // Check if cancellation verification failed
                if (json.status === "warning") {
                    alert("âš  WARNING: " + json.message + "\n\nCannot mark as No Repro until remote job is confirmed cancelled.");
                    resetUI();
                    updateStatus("Cancellation Required", "bg-yellow-600");
                    return;
                }

                alert("Marked as No Repro. You can now generate the sheet row.");
                updateStatus("No Repro Marked", "bg-green-600");

            } catch (e) {
                alert("Error marking no repro: " + e);
                resetUI();
            }
        }

        function getFormData() {
            return {
                competition_id: document.getElementById('competition_id').value,
                datarow_id: document.getElementById('datarow_id').value,
                debug_step: parseInt(document.getElementById('debug_step').value),
                code: document.getElementById('code').value,
                original_plan: "", // Not used for row generation but kept for compatibility
                proposed_analysis: window.currentAnalysis || "" // Pass the extracted analysis
            };
        }

        async function pollStatus(datarow_id, debug_step, originalData) {
            pollInterval = setInterval(async () => {
                try {
                    // Poll Logs
                    const logRes = await fetch(`/api/logs/${datarow_id}/${debug_step}`);
                    const logJson = await logRes.json();
                    const terminal = document.getElementById('live_terminal');
                    if (logJson.content) {
                        terminal.innerText = logJson.content;
                        terminal.scrollTop = terminal.scrollHeight;
                    }

                    // Poll Status
                    const res = await fetch(`/api/status/${datarow_id}/${debug_step}`);
                    const json = await res.json();

                    if (json.status === 'completed') {
                        clearInterval(pollInterval);
                        updateStatus("Completed", "bg-green-600");
                        resetBtn();
                        document.getElementById('loader').classList.add('hidden');
                        alert("Run completed! You can now generate the sheet row.");
                    }
                } catch (e) {
                    console.error("Polling error", e);
                }
            }, 2000);
        }

        function updateStatus(text, colorClass) {
            const badge = document.getElementById('statusBadge');
            badge.innerText = text;
            badge.className = `px-3 py-1 rounded-full text-xs font-mono text-white ${colorClass}`;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const seconds = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').innerText = seconds + "s";
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            clearInterval(pollInterval);
        }

        function resetBtn() {
            document.getElementById('runBtn').disabled = false;
            document.getElementById('runBtn').classList.remove('opacity-50');
            document.getElementById('cancelBtn').disabled = true;
            document.getElementById('cancelBtn').classList.add('opacity-50');
        }

        function resetUI() {
            stopTimer();
            document.getElementById('loader').classList.add('hidden');
            resetBtn();
            updateStatus("Error", "bg-red-600");
        }

        function copyText(id) {
            const text = document.getElementById(id).value || document.getElementById(id).innerText;
            navigator.clipboard.writeText(text);
            const el = document.getElementById(id).parentElement;
            const originalBg = el.style.backgroundColor;
            el.style.backgroundColor = "#374151";
            setTimeout(() => { el.style.backgroundColor = originalBg; }, 200);
        }

        function parseRow() {
            const raw = document.getElementById('paste_row').value.trim();
            if (!raw) return;

            // Split by tab
            const parts = raw.split('\t');

            if (parts.length >= 6) {
                // Datarow ID (Col A / Index 0)
                const datarowId = parts[0].trim();
                if (datarowId) document.getElementById('datarow_id').value = datarowId;

                // Competition ID (Col D / Index 3)
                const compId = parts[3].trim();
                if (compId) document.getElementById('competition_id').value = compId;

                // Analysis (Col E / Index 4)
                // We need to store this somewhere to pass it to the generation script
                if (parts.length > 4) {
                    const analysis = parts[4];
                    const cleanAnalysis = analysis.replace(/^"|"$/g, '').replace(/""/g, '"');
                    // Store in a global variable or hidden input
                    window.currentAnalysis = cleanAnalysis;
                    console.log("Extracted Analysis:", cleanAnalysis.substring(0, 50) + "...");
                }

                // Code (Col F / Index 5)
                const code = parts[5]; // Don't trim code, whitespace matters
                const cleanCode = code.replace(/^"|"$/g, '').replace(/""/g, '"');
                if (cleanCode) document.getElementById('code').value = cleanCode;

                // Debug Step (Col Q / Index 16)
                if (parts.length > 16) {
                    const step = parts[16].trim();
                    if (/^\d+$/.test(step)) {
                        document.getElementById('debug_step').value = step;
                    } else {
                        document.getElementById('debug_step').value = "0";
                    }
                } else {
                    document.getElementById('debug_step').value = "0";
                }

            } else {
                alert("Row format not recognized. Expected at least 6 columns.");
            }
        }
    </script>
</body>

</html>